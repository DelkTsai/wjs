// @require WjsLoader > JsClass
// @require WjsLoader > CssLink
// @require JsScript > SchemeWebCom
// @require JsClass > BasicWebComOption
// @require JsMethod > urlQueryReplace
// @require JsMethod > classProtoLineage
// @require JsMethod > inheritObject
// @require JsMethod > upperCaseFirstLetter
// @require JsMethod > isPlainObject
// @require JsMethod > objectFill
(function(k){k.register("WjsLoader","WebCom",{protoBaseClass:"WebCom",__construct:function(){this.wjs.extendObject(this,{webCompCounter:0,webCompSchemes:{},wjsShortcuts:!1,instances:{},instancesCount:{},optionsProtos:{},webComList:{}});this.protoAddPartProxy=this.protoAddPart.bind(this);this.protoAdd(this.protoBaseClass,k.retrieve("WebComScheme","Scheme"+this.protoBaseClass));k.lib.Loader.__construct.call(this);var a=this.wjs.urlQueryParse();if(a[this.type]){var c=this,b=a[this.type],d=0,e,f=Object.keys(b),
g={},h=this.type;delete a[h];this.wjs.urlQueryReplace(a);for(g[h]=[];e=f[d++];)g[h].push(b[e]);this.wjs.use(g,function(){for(var a=0;e=f[a++];)c.instance(b[e])})}},parse:function(a,c,b){this.protoAdd(a,k.retrieve(this.type,a));k.lib.Loader.parse.apply(this,arguments);return c},protoName:function(a){return this.protoBaseClass+(a&&a!==this.protoBaseClass?"\\"+a:"")},protoAdd:function(a,c){this.bundleEach(a,c,this.protoAddPartProxy)},protoAddPart:function(a,c){var b=this.protoName(a),d={type:a,loader:this,
classExtends:null!==c.classExtends?c.classExtends||this.protoBaseClass:!1,__superProtos:{}};c=this.wjs.extendObject({variables:{},options:{},optionsDefault:{}},c,!0);this.webCompSchemes[b]=c;this.wjs.classExtend(b,d);d=this.wjs.classProto(b).prototype;d.typeGlobal=this.wjs.classProtoLineage(b).join("-");for(var b=Object.keys(c),e,f=0,g;e=b[f++];)g="protoParse"+this.wjs.upperCaseFirstLetter(e),g=this[g]?g:"protoParseDefault",this[g](d,c,e)},bundleEach:function(a,c,b){b(a,c);if(c.bundle)for(var d=Object.keys(c.bundle),
e,f=0;e=d[f++];)this.bundleEach(a+"."+e,c.bundle[e],b)},optionCreate:function(a,c,b,d){a=Object.getPrototypeOf(a);"object"!==typeof d&&(d={defaults:d});d.name=b;d.protoName=c;d.classExtends=a.options&&a.options[b]?a.options[b].className:"BasicWebComOption";d.autoInit=void 0!==d.autoInit?d.autoInit:!0;d.required=void 0!==d.required?d.required:!1;this.wjs.classExtend(d.protoName,d);return new (this.wjs.classProto(d.protoName))(b)},optionDestroy:function(a){this.wjs.classProtoDestroy(a.protoName)},methodsFlatten:function(a,
c,b,d,e,f){var g=Object.keys(c[b]),h,k=0;f=f||"__"+b;d=d||1;for(e=e||0;h=g[k++];){var l=f+"__"+h;e+1<d&&this.wjs.isPlainObject(c[b][h])?this.methodsFlatten(a,c[b],h,d,e+1,l):a[l]=c[b][h]}},inheritObject:function(a,c,b){var d=Object.getPrototypeOf(a),d=d[b]?this.wjs.extend(!0,{},d[b]):{};a[b]=this.wjs.extend(!0,d,c[b])},protoParseDefault:function(a,c,b){a[b]="object"!==typeof c[b]||null===c[b]?c[b]:this.wjs.extend(Array.isArray(c[b])?[]:{},c[b])},protoParseVariables:function(a,c,b){this.inheritObject(a,
c,b)},protoParseOptions:function(a,c){var b,d=0,e;a.options={};if(c.options)for(e=Object.keys(c.options);b=e[d++];){var f="BasicWebComOption#"+a.typeGlobal+"#"+b,g=this.wjs.loaders.WebCom||this,h=g.optionsProtos[f],k=c.options[b];h||(g.optionsProtos[f]=h=this.optionCreate(a,f,b,k));this._protoParseOptionsSave(a,b,h)}f=Object.getPrototypeOf(a);if(f.options)for(d=0,e=Object.keys(f.options);b=e[d++];)a.options[b]||this._protoParseOptionsSave(a,b,f.options[b])},_protoParseOptionsSave:function(a,c,b){a.options[c]=
b;a.variables[c]=b.defaults||a.variables[c]},protoParseOptionsDefault:function(a,c){a.optionsDefault=this.wjs.inheritObject(c,"optionsDefault")},protoParseMixin:function(a,c,b){for(var d=0,e;e=c[b][d++];)this._mixinProto(a,e)},_mixinProto:function(a,c){var b=this.wjs.classProtos[c].prototype;this._mixinProtoItem(a,b,"variables");this._mixinProtoItem(a,b,"options");this._mixinProtoItem(a,b,"optionsDefault")},_mixinProtoItem:function(a,c,b){c[b]&&(a[b]||(a[b]=Array.isArray(c[b])?[]:{}),this.wjs.objectFill(a[b],
c[b],!0))},protoParseCallbacks:function(a,c){this.methodsFlatten(a,c,"callbacks",2)},instance:function(a,c){var b=this.wjs,d=this.protoName(a),e=b.get(this.type,a)||{};this.wjs.extendObject(e,c||{});if(this.wjs.classMethods[d])return new (b.classProto(d))(c);b.err("Trying to create undefined instance "+d)},instanceRegister:function(a){this.wjs.loaders.WebCom.webComRegister(a);this.instancesCount[a.type]=(this.instancesCount[a.type]||0)+1;this.instances[a.id]=a},instanceRemove:function(a){this.wjs.loaders.WebCom.webComRemove(a);
this.instancesCount[a.type]--;this.instancesCount[a.type]||delete this.instancesCount[a.type];delete this.instances[a.id]},webComRegister:function(a){this.webComList[a.id]=a;this.webCompCounter+=1},webComRemove:function(a){delete this.webComList[a.id]},wjsInclude:function(a,c,b){a=this.wjs.get(a,c);a.dom=b;a.domImported=!0;this.instance(c,a)}})})(WjsProto);