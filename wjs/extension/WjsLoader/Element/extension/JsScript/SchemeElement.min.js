// @require JsMethod > arrayDeleteItem
(function(g){g.register("WebComScheme","SchemeElement",{classExtends:"Binder",type:"Element",variables:{parent:null,children:[],listeners:{},plugins:{},pluginsList:[],pluginMethods:{},pluginSharedMethod:null,pluginSharedQueue:null,pluginSharedMethodCallback:null,frameNextEnabled:!1,global:!1,globalParents:{},playFrameStamp:0,formulaVarListenersCounter:{}},options:{global:{defaults:!1},fps:{defaults:24,apply:!0,dump:!0},playPlayer:{defaults:null,define:function(a,b,c){b&&(a.optionApply("parent",c),
!0===b?b=a:null===b&&null!==a.parent&&null!==a.parent.playPlayer&&(b=a.parent.playPlayer),a.stateSet("playing",b.playStarte));return b}},autoPlay:{defaults:!1,define:function(a,b){b&&a.play()},dump:!0},children:{define:function(a,b){var c=[];if("object"===typeof b)for(var d=Object.keys(b),f=0,e;e=b[d[f++]];)e=a.wjs.extendObject({},e),c.push(a.childAdd(e));return c}},parentShortcut:{defaults:!1,define:function(a,b){b&&a.parent&&(a.parent[b]=a)}},plugins:{defaults:[],define:function(a,b){a.pluginAddMultiple(b)},
dump:[]},parent:{defaults:null,define:function(a,b){b&&b.isA("Element")&&b.elementAppend(a)},destroy:function(a){null!==a.parent&&a.parent.elementRemove(a)}}},states:{playing:!1,renderEnabled:!0},__construct:function(a){this.playFrameExecuteProxy=this.playFrameExecute.bind(this);this.playFrameNextEnableProxy=this.frameNextEnable.bind(this);this.__super("__construct",arguments);this.render()},variableSet:function(a,b){b&&b.formula&&this.wjs.formula.formulas[b.formula].preset&&this.formulaListen(this.wjs.formula.formulas[b.formula].preset);
this.__super("variableSet",arguments)},formulaListen:function(a){var b=this;this.formulaInspectEvent(a,function(a){var d=a.formula,f=b.formulaVarListenersCounter;f[d]||b.wjs.window.addEventListener(a.eventNameUpdate,b.playFrameNextEnableProxy);f[d]=f[d]||0;f[d]++})},formulaInspectEvent:function(a,b){var c=this;this.objectInspect(a,function(a){a&&a.formula&&(a=c.wjs.formula.formulas[a.formula])&&a.eventTrigger&&b(a)})},objectInspect:function(a,b,c){c=c||0;for(var d=Object.keys(a),f=0,e,g;(e=d[f++])&&
(g=b(a[e],e,c),!1!==g&&"object"===typeof a[e]&&a[e]&&this.objectInspect(a[e],b,c+1),null!==g););},exit:function(a){var b=this,c=arguments;b.stop();b.pluginsClear();b.empty(function(){b.__super("exit",c)})},childAdd:function(a){var b=this.wjs,c;c=a.type?a.type.split("::"):["Element",!1];delete a.type;a.parent=this;return b.loaders[c[0]].instance(c[1],a)},elementAppend:function(a){a.parent&&a.parent.elementRemove(a);this.dom&&a.dom&&this.dom.appendChild(a.dom);this.children.push(a);this.wjs.extendObject(a.globalParents,
this.globalParents);this.global&&(a.globalParents[this.id]=this);a.parent=this;for(var b=Object.keys(a.globalParents),c,d=0;c=b[d++];)a.globalParents[c].globalChildAppend(a)},elementAppendTo:function(a){a.elementAppend(this)},elementRemove:function(a){for(var b=Object.keys(a.globalParents),c,d=0;c=b[d++];)a.globalParents[c].globalChildRemove(a);this.wjs.arrayDeleteItem(this.children,a);a.parent=null;a.globalParents={}},globalChildAppend:g._e,globalChildRemove:g._e,treeMap:function(a,b){var c="string"===
typeof a?this[a]:a;this.childrenMap("treeMap",arguments);c.apply(this,b)},childrenMap:function(a,b){for(var c=0,d,f="function"===typeof a;d=this.children[c++];)f?a.apply(d,b):d[a].apply(d,b)},pluginAdd:function(a,b,c){var d=this.wjs,f=this.plugins,e=this.pluginsList;"object"===typeof a?(d=a,c=b,a=a.type):d=d.loaders.Plugin.instance(a,b);d.elementAdd(this);f[a]=f[a]||[];f[a].push(d);e.push(d);this.render();c&&c(d);return d},pluginAddMultiple:function(a,b,c){for(var d=0,f,e;e=a[d++];)c&&this.pluginGet(e.type)||
(b&&this.wjs.extendObject(e,b),e.isA&&e.isA("Plugin")?(f=e,e=void 0):f=e.type,this.pluginAdd(f,e))},pluginRemoveMultiple:function(a){for(var b=0,c;c=a[b++];)c=c.type||c,this.pluginGet(c)&&this.pluginRemove(c)},pluginGet:function(a){return this.plugins[a]?1===this.plugins[a].length?this.plugins[a][0]:this.plugins[a]:!1},pluginRemove:function(a){var b={},c=this.plugins,d;if("string"===typeof a)return this.pluginRemove(this.pluginGet(a));if(a instanceof Array){for(a=0;d=c[a++];)b[a]=this.pluginRemove(d);
return b}a.elementRemove(this);this.wjs.arrayDeleteItem(c[a.type],a);this.wjs.arrayDeleteItem(this.pluginsList,a);0===Object.keys(c[a.type]).length&&delete c[a.type]},pluginsClear:function(){for(var a=0,b;b=this.pluginsList[a++];)this.pluginRemove(b)},pluginsInvoke:function(a,b){for(var c=0,d;d=this.pluginsList[c++];)if("function"===typeof d[a])d[a](this,b)},render:function(a){!0!==this.stateGet("renderEnabled")||a&&a!==this.playPlayer&&!0!==this.playerPropagate||(a=this.renderReset(),this.parent&&
this.parent.renderChild(this,a),this.pluginsInvoke("renderDom",a),this.renderDom(a),this.renderChildren())},renderReset:function(){return{}},renderDom:g._e,renderChildren:function(a){for(var b=0,c;c=this.children[b++];)c.render(a)},renderChild:g._e,empty:function(a){this.emptyNext(a)},emptyNext:function(a){var b=this;this.children.length?this.children[0].exit(function(){b.emptyNext(a)}):this.emptyComplete(a)},emptyComplete:function(a){a()},play:function(){this.playStarted=!0;this.treeMap("playStateStart",
[this]);this.playStampStart=(new Date).getTime();this.frameNextEnable();this.playFrameExecute();this.trigger("playStarted",[this])},stop:function(){this.treeMap("playStateQuit",[this]);this.playStarted=!1;this.trigger("play_stopped",[this])},playStateStart:function(a){a===this.playPlayer&&this.stateSet("playing",!0)},playStateQuit:function(a){a===this.playPlayer&&this.stateSet("playing",!1)},playFrameNumber:function(){return!1===this.playStarted?0:Math.round((this.playFrameStamp-this.playStampStart)/
1E3*this.fps)},playFrameExecute:function(){this.frameNextEnabled=!1;this.playFrameStamp=(new Date).getTime();this.playFrameCurrent=this.playFrameNumber();this.render()},playFrameNextLaunch:function(){this.frameNextEnabled&&this.wjs.window.setTimeout(this.playFrameExecuteProxy,1E3/this.fps*(this.playFrameCurrent+1)+this.playStampStart-this.playFrameStamp)},frameNextEnable:function(){!1===this.frameNextEnabled&&null!==this.playPlayer&&!0===this.playPlayer.playStarted&&(this.playPlayer!==this?this.playPlayer.frameNextEnable():
(this.frameNextEnabled=!0,this.playFrameNextLaunch()))},frame:function(){this.play();this.stop()},result:function(a){return this.wjs.formula.result(a,this)}})})(WjsProto);