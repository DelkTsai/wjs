(function(h){var g;h.wjsContext=h;g=function(a){this.options=a=this.extendOptions(a);h[a.settings?a.settings.clientName:"wjs"]=this;"loading"!==h.window.document.readyState?this.init():h.window.addEventListener("load",this.init.bind(this))};g.prototype={init:function(){var a=this,b=a.options;a.extendObject(a,{context:h,window:h.window||window,document:h.document||window.document,version:b.settings?b.settings.version:"[$version]-headless",readyComplete:!1,packageDefault:{},loaders:{},loadersExtra:[],
loadersBasic:[],extLoaded:{WjsLoader:{}},extRequire:{},processes:[],processCounter:0,processStack:[],processParent:void 0,classProtos:{},classMethods:{},cacheReg:{},settings:{clientName:"",paramExtra:"",paramInc:"",paramExc:"",paramToken:"",pathResponse:"",cacheToken:""}});a.extendObject(a,b);a.classExtend("WjsLoader",g.proto.Loader);a.classExtend("WjsProcess",g.proto.Process);a.loaderAdd("JsLink",g.retrieve("WjsLoader","JsLink"),!0);a.loaderAdd("WjsLoader",g.retrieve("WjsLoader","WjsLoader"),!0);
for(var c=0;c<a.loadersBasic.length;c++)a.loaderAdd(a.loadersBasic[c],void 0,!0);a.process(null,{complete:function(){a.readyComplete=!0;b.complete&&b.complete.call(a);a.callbacks(g.readyCallbacks[a.settings.clientName]||[])}}).responseParse(a.packageDefault)},callbacks:function(a,b){for(var c=b?"apply":"call",d=0;d<a.length;d++)a[d][c](this,b)},urlToken:function(a){var b=this.settings.cacheToken;return b?(-1===a.indexOf("?")?a+"?":a)+"&"+b:a},loaderAdd:function(a,b,c,d){var e=this,f="WjsLoader"+a;
b=b||{};e.loaders[a]||(b.type=a,b.classExtends="WjsLoader"+(b.loaderExtends||""),b.loaderExtends?e.loadersExists([b.loaderExtends],function(){e.loaderBuild(a,f,b,c,d)}):e.loaderBuild(a,f,b,c,d))},loaderBuild:function(a,b,c,d,e){this.classExtend(b,c);this.loaders[a]=new (this.classProto(b))(a);this.extRequire[a]={};b=this.extLoaded;b[a]=b[a]||{};d&&(b.WjsLoader[a]=c);e&&e()},loadersExists:function(a,b){for(var c=0,d=[],e;e=a[c++];)this.loaders[e]||d.push(e);return 0<d.length?this.process({WjsLoader:d},
{stacked:!1,complete:b}):b()},process:function(a,b){return new (this.classProto("WjsProcess"))(a,b,this)},processFor:function(a,b){for(var c=0,d,e,f,k=this.processes;d=k[c++];)for(e=0;f=d.extRequests[e++];)if(f.type===a&&f.name===b)return d},use:function(a,b){var c=this.extendArgs(arguments);return this.process(c[0],c[1])},get:function(a,b){var c=this.extLoaded[a];return c&&c.hasOwnProperty(b)?c[b]:!1},destroy:function(a,b,c){var d=this,e;if(c&&c.async)return delete c.async,d.window.setTimeout(function(){d.destroy(a,
b,c)}),null;e=d.extendArgs(arguments);"boolean"===typeof e[1]&&(e[1]={});c=d.extendOptions({destroy:!0,dependencies:!0===arguments[1]||!0===arguments[2]},e[1]);return d.process(e[0],c)},destroyRequest:function(a,b,c,d){var e=this;if("WjsLoader"!==b||"WjsLoader"!==c&&"JsLink"!==c&&-1===e.loadersBasic.indexOf(c)){var f=e.extRequire[b]?e.extRequire[b][c]:null,k=b+"::"+c,g=e.cacheReg[k];a[b]=a[b]||[];a[b].push(c);g&&(e.destroyRequest(a,"CacheLink",g,d),delete e.cacheReg[k]);f&&d.dependencies&&e.regEach(f,
function(f,k){e.requireShared(b,c,f,k,a)||e.destroyRequest(a,f,k,d)})}},requireShared:function(a,b,c,d,e){var f=this,k=!1;f.regEach(f.extRequire,function(g,l){var h=f.extRequire[g][l];if(g!==a&&l!==b&&h[c]&&!(-1===h[c].indexOf(d)||e&&e[g]&&-1!==e[g].indexOf(l)))return k=!0,!1});return k},regEach:function(a,b){for(var c=0,d,e=Object.keys(a),f;c<e.length;c++)for(f=Array.isArray(a[e[c]])?a[e[c]]:Object.keys(a[e[c]]),d=0;d<f.length;d++)if(!1===b.call(this,e[c],f[d]))return!1;return!0},regRem:function(a,
b,c){delete a[b][c];this.objectIsEmpty(a[b])&&delete a[b]},regNext:function(a){var b=Object.keys(a)[0],c;return b&&(c=Object.keys(a[b])[0])?{type:b,name:c,data:a[b][c]}:!1},ajax:function(a){var b=new this.window.XMLHttpRequest,c=a.data?this.param(a.data):void 0,d=a.method||"GET",e=a.url;b.open(d,"GET"===d&&c?e+"?"+c:e,void 0!==a.async?a.async:!0);b.onreadystatechange=function(){4===b.readyState&&(200===b.status?a.success&&"function"===typeof a.success&&a.success(b):a.error&&a.error(b))};"POST"===
d&&b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(c)},param:function(a){for(var b=0,c=[],d,e=Object.keys(a);d=e[b++];)c.push(d+"="+a[d]);return c.join("&")},extendObject:function(a,b,c){for(var d=0,e,f=Object.keys(b),k;e=f[d++];)k=b[e],c&&"object"===typeof k&&null!==k?(a[e]=a[e]||(Array.isArray(k)?[]:{}),this.extendObject(a[e],k)):a[e]=k;return a},extendArgs:function(a){var b=a[0],c=a[1],d={};"string"===typeof b&&(d[b]=[c],b=d,c=a[2]);return[b,c]},extendOptions:function(a,
b){a?"function"===typeof a&&(a={complete:a}):a={};return b?this.extendObject(a,this.extendOptions(b)):a},extendProto:function(a,b){for(var c=0,d=Object,e,f=d.keys(b);e=f[c++];)d.defineProperty(a,e,d.getOwnPropertyDescriptor(b,e));return a},objectIsEmpty:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},classExtend:function(a,b){var c=this.classMethods;c[a]?this.extendProto(c[a],b):c[a]=b},classProto:function(a){var b=this.classProtos,c=this.classMethods[a];if(!b[a]){var d,e=Object;
(d=c&&c.classExtends?c.classExtends:!1)&&(e=this.classProto(d));d=b[a]=function(){var a=this.__construct;a&&(arguments.length?a.apply(this,arguments):a.call(this))};d.prototype=Object.create(e.prototype);this.extendObject(d.prototype,{constructor:e,className:a,wjs:this})}c&&this.extendProto(b[a].prototype,c);return b[a]},classProtoDestroy:function(a,b){var c=this.classProtos,d=this.classMethods;c[a]&&delete c[a];!b&&d[a]&&delete d[a]},onload:function(a,b){var c=!1,d=function(e){c=!0;a.removeEventListener("load",
d);b()};a.addEventListener("load",d);this.window.setTimeout(function(){c||b()},200)},err:function(a,b){var c=this.window.console,d="["+this.settings.clientName+" error] : ";if(!b&&c)c.error(d+a);else throw new this.window.Error(d+a);}};g.proto={};g.common={};g.WjsLoader={};g.readyCallbacks={};g.context=h;g.ready=function(a,b){var c=this.readyCallbacks;"function"===typeof a&&(b=a,a="wjs");h[a]&&!0===h[a].readyComplete?h[a].window.setTimeout(function(){b()}):(c[a]=c[a]||[],c[a].push(b))};g.event=function(a,
b){var c;c=h.window.document;c.createEvent?(c=c.createEvent("HTMLEvents"),c.initEvent(a,!0,!0),c.eventName=a,b.dispatchEvent(c)):(c=c.createEventObject(),c.eventType=c.eventName=a,b.fireEvent("on"+a,c))};g.register=function(a,b,c){var d=this.common;d[a]=d[a]||{};d[a][b]=c;g.event("wjsRegister::"+a+"::"+b,h.window)};g.registerGet=function(a,b){var c=this.common;return c[a]&&c[a][b]?c[a][b]:!1};g.registerListen=function(a,b,c){var d=this,e=g.registerGet(a,b);if(e)c(e);else{var f="wjsRegister::"+a+"::"+
b,k=function(){h.window.removeEventListener(f,k);c(d.common[a][b])};h.window.addEventListener(f,k)}};g.retrieve=function(a,b){return this.common[a][b]};g.cache=function(a,b,c){g.register("cache",a+"/"+b,c)};h.WjsProto=g;g.proto.Loader={type:"",preventReload:!0,processType:"server",__construct:function(){g.common[this.type]=g.common[this.type]||{}},__destruct:function(){},parse:function(a,b,c){return b},register:function(a,b,c){},link:function(a){this.wjs.use(this.type,a)},destroy:function(a,b){return!0},
requestUse:function(a,b){return{mode:this.processType,type:this.type,name:a}},requestDestroy:function(a,b){return{mode:"parse",type:this.type,name:a}},registerListen:function(a,b,c){var d=this;g.registerListen(a,b,function(){d.register.call(d,a,b,c)})}};g.proto.Process={__construct:function(a,b,c){var d=this;b=c.extendOptions(b||{});!b.processParent&&c.processParent&&(b.processParent=c.processParent);c.extendObject(d,{id:c.processCounter++,wjs:c,destroy:b.destroy||!1,booted:!1,parseQ:{},async:b.async||
!0,callbacks:b.complete?[b.complete]:[],extRequests:[],exclude:b.exclude,stacked:void 0!==b.stacked?b.stacked:!0,request:a,options:b,next:[],processStack:[],output:{}});d.wjs.processes.push(d);a&&c.loadersExists(Object.keys(a),function(){d.wjs.window.setTimeout(function(){d.boot()})})},boot:function(){var a=this,b=a.wjs,c=a.request,d={},e,f={};if(!0!==a.booted){a.booted=!0;if(a.stacked&&(e=a.options.processParent?a.options.processParent.processStack:b.processStack,-1===e.indexOf(this)&&e.push(this),
0!==e.indexOf(this))){a.booted=!1;return}if(a.destroy)b.regEach(c,function(c,e){b.destroyRequest(d,c,e,a.options)}),c=d;else if(!b.regEach(c,function(c,d){var e=b.processFor(c,d);if(e&&e!==a)return e.next.push(a),!1})){a.booted=!1;return}b.regEach(c,function(c,d){var e,g,h="request"+(a.destroy?"Destroy":"Use");(e=b.get(c,d))&&a.options.reload&&(e=!1,delete b.extLoaded[c][d],b.cacheReg[c+"::"+d]&&delete b.extLoaded.CacheLink[b.cacheReg[c+"::"+d]]);if(e&&!1===a.destroy)a.output[c]=a.output[c]||{},a.output[c][d]=
e;else if(b.loaders[c]){for(e=0;e<b.processes.length;e++)if(g=b.processes[e],g.destroy===a.destroy&&g.parseQ[c]&&g.parseQ[c][d])return a.booted=!1,a.loadingComplete(!0),g.itemProcess(c,d,function(){return b.process(a.request,a.options)}),!1;a.extRequests.push(b.loaders[c][h](d,a))}else f[c]=f[c]||{},f[c][d]={"#data":"WJS_ERR_PULL_UNDEFINED_LOADER_TYPE"},b.err("Load error for "+c+"::"+d+" : WJS_ERR_PULL_UNDEFINED_LOADER_TYPE")})&&a.loadingStart(f)}},loadingStart:function(a){var b,c,d,e=this,f=e.wjs,
g=e.extRequests,h,l=f.settings,m={};a=a||{};for(b=0;b<g.length;b++)switch(h=g[b],c=h.type,d=h.name,h.mode){case "server":c=l.paramInc+"["+c+"]";m[c]=m[c]?m[c]+","+d:d;break;case "parse":a[c]=a[c]||{},a[c][d]={"#data":h.data}}if(f.objectIsEmpty(m))e.responseParse(a);else{if(e.exclude)if(!0===e.exclude)m[l.paramExc]="1";else for(c=Object.keys(e.exclude),b=0;b<c.length;b++)m[l.paramExc+"["+c[b]+"]"]=e.exclude[c[b]].join(",");l.cacheToken&&(m[l.paramToken]=l.cacheToken);f.ajax({url:l.pathResponse+"?"+
f.param(m)+l.paramExtra,method:"GET",async:e.async,success:function(b){f.extendObject(a,JSON.parse(b.responseText),!0);e.responseParse(a)}})}},loadingComplete:function(a){var b=this.wjs,c=0,c=b.processParent;b.processes.splice(b.processes.indexOf(this),1);a||(b.processParent=this,b.callbacks(this.callbacks,[this.output,this]),b.processParent=c);Object.freeze(this);if(this.stacked&&(b=this.options.processParent?this.options.processParent.processStack:this.wjs.processStack,c=b.indexOf(this),-1!==c&&
(b.splice(b.indexOf(this),1),!a)))for(c=0;c<b.length;c++)b[c].boot();for(c=0;c<this.next.length;c++)this.next[c].boot()},responseParse:function(a){var b=this,c=b.wjs,d=b.parseQ;c.extendObject(d,a,!0);c.loadersExists(Object.keys(d),function(){b.responseParseNext()})},responseParseNext:function(){var a=this,b=a.wjs;b.window.setTimeout(function(){var c,d=Object.keys,e=a.parseQ;a.destroy&&e.WjsLoader&&1<d(e).length&&(e=b.extendObject({},e,!0),delete e.WjsLoader);for(;c=b.regNext(e);){if(a.itemProcess(c.type,
c.name))return;b.regRem(e,c.type,c.name)}0<d(e).length&&a.wjs.err("Parse queue not empty.");a.loadingComplete()})},itemProcess:function(a,b,c){var d=this.parseQ[a][b];c&&(d["#callbacks"]=d["#callbacks"]||[],d["#callbacks"].push(c));return this.destroy?(this.itemDestroy(a,b,c),!0):this.wjs.get(a,b)?!1:(this.itemParse(a,b,c),!0)},itemProcessComplete:function(a,b){var c=this.wjs,d=this.parseQ[a][b]["#callbacks"];c.regRem(this.parseQ,a,b);d?c.callbacks(d):this.responseParseNext()},itemParse:function(a,
b){var c=this,d=c.wjs,e,f=c.parseQ[a][b];if(void 0!==f["#require"]&&(d.extRequire[a][b]=d.extRequire[a][b]||{},d.extendObject(d.extRequire[a][b],f["#require"]),c.requireMissing(f["#require"]))){e=f["#require"];f["#require"]=void 0;d.use(e,{stacked:!1,complete:function(){c.itemParse(a,b)}});return}"string"===typeof f["#data"]&&0===f["#data"].indexOf("cache://")?(d.cacheReg[a+"::"+b]=f["#data"].split("://")[1],g.registerListen("cache",a+"/"+b,function(d){f["#data"]=d;c.itemParseSave(a,b,d)})):c.itemParseSave(a,
b,f["#data"])},itemParseSave:function(a,b,c){var d=this.wjs,e=d.loaders[a];"string"===typeof c&&0===c.indexOf("WJS_ERR_")?(d.err("Parse error for "+a+"::"+b+" : "+c),c=new d.window.Error(c)):c=e.parse(b,c,this);!1!==c&&this.itemParseComplete(a,b,c)},itemParseComplete:function(a,b,c){this.wjs.extLoaded[a]&&(this.wjs.extLoaded[a][b]=c,this.output[a]=this.output[a]||[],this.output[a][b]=c);this.itemProcessComplete(a,b)},itemDestroy:function(a,b){var c=this.wjs,d=c.get(a,b);c.loaders[a]&&!1!==d&&!1===
c.loaders[a].destroy(b,d,this)||this.itemDestroyComplete(a,b)},itemDestroyComplete:function(a,b){var c=this.wjs;c.loaders[a]&&(delete c.extLoaded[a][b],delete c.extRequire[a][b]);this.itemProcessComplete(a,b)},requireMissing:function(a){var b=this.wjs,c=!1;b.regEach(a,function(a,e){if(!1===b.get(a,e))return c=!0,!1});return c}};g.register("WjsLoader","JsLink",{processType:"parse",destroy:function(a,b){b.parentNode&&b.parentNode.removeChild(b);return!0},parse:function(a,b,c){if("WJS_PUSH_JSLINK_INCLUDED"===
b)return this.wjs.document.head.querySelector('script[src="'+a+'"]')||!0;var d=this,e=d.wjs,f=e.document.createElement("script");b=e.urlToken(b||a);return b instanceof e.window.Error?!0:(d.wjs.onload(f,function(){d.parseLinkLoaded(a,f,c)}),f.setAttribute("src",b),e.document.head.appendChild(f),!1)},parseLinkLoaded:function(a,b,c){c.itemParseComplete(this.type,a,b)}});g.register("WjsLoader","WjsLoader",{loaderExtends:"JsLink",processType:"server",destroy:function(a,b){var c=this.wjs,d=c.loaders;d[a]&&
(d[a].__destruct(),c.classProtoDestroy("WjsLoader"+a),delete d[a],delete c.extLoaded[a],delete c.extRequire[a]);return d.JsLink.destroy.call(this,a,b)},parse:function(a,b,c){var d=this.wjs;if(!0===b)return d.loaderAdd(a),!0;this.registerListen(this.type,a,c);d.loaders.JsLink.parse.call(this,a,b,c);return!1},parseLinkLoaded:function(a,b,c){},register:function(a,b,c){a=g.retrieve(this.type,b);this.wjs.loaderAdd(b,a);c.itemParseComplete(this.type,b,a)}})})(this);
